name: "Build and Release - Tauri v1"
on:
  push:
    branches: [ main ]
  workflow_dispatch:
jobs:
  build-macos:
    permissions:
      contents: write
    runs-on: macos-12  # Changed from macos-14 for better Tauri v1 support
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      # Changed from Bun to npm for Tauri v1 compatibility
      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          
      - name: Setup Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin
          
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
          
      # Fixed dependencies installation for Tauri v1
      - name: Install dependencies for Tauri v1
        run: |
          echo "ðŸ“¦ Installing dependencies for Tauri v1..."
          npm ci --legacy-peer-deps || npm install --legacy-peer-deps
          echo "âœ… Dependencies installed"
          
      # Enhanced icon creation
      - name: Create proper icons for v1
        run: |
          mkdir -p src-tauri/icons
          echo "ðŸŽ¨ Creating high-quality icons for Tauri v1..."
          
          # Try to create better icons with Python
          cat > create_icons.py << 'EOF'
          from PIL import Image, ImageDraw
          import os
          
          def create_icon(size, filename):
              # Create blue gradient background
              img = Image.new('RGBA', (size, size), (30, 144, 255, 255))
              draw = ImageDraw.Draw(img)
              
              # Add white border and inner design
              margin = max(2, size // 8)
              draw.rectangle([margin, margin, size-margin, size-margin], 
                           outline=(255, 255, 255, 255), width=max(1, size//16))
              
              # Add center dot
              center = size // 2
              dot_size = size // 6
              draw.ellipse([center-dot_size, center-dot_size, center+dot_size, center+dot_size], 
                          fill=(255, 255, 255, 255))
              
              img.save(filename)
              print(f"Created {filename} ({size}x{size})")
          
          # Create all required sizes
          create_icon(32, 'src-tauri/icons/32x32.png')
          create_icon(128, 'src-tauri/icons/128x128.png')
          create_icon(256, 'src-tauri/icons/128x128@2x.png')
          create_icon(512, 'src-tauri/icons/icon.png')
          
          # Copy for other formats
          import shutil
          shutil.copy('src-tauri/icons/icon.png', 'src-tauri/icons/icon.icns')
          shutil.copy('src-tauri/icons/icon.png', 'src-tauri/icons/icon.ico')
          
          print("âœ… All icons created successfully!")
          EOF
          
          python3 create_icons.py 2>/dev/null || {
            echo "âš ï¸ Python/PIL not available, using simple fallback..."
            echo 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==' | base64 -d > src-tauri/icons/32x32.png
            cp src-tauri/icons/32x32.png src-tauri/icons/128x128.png
            cp src-tauri/icons/32x32.png src-tauri/icons/128x128@2x.png
            cp src-tauri/icons/32x32.png src-tauri/icons/icon.png
            cp src-tauri/icons/32x32.png src-tauri/icons/icon.icns
            cp src-tauri/icons/32x32.png src-tauri/icons/icon.ico
            echo "âœ… Fallback icons created"
          }
          
          echo "ðŸ“‹ Icon files created:"
          ls -la src-tauri/icons/
          
      # Enhanced debug for Tauri v1
      - name: Debug Tauri v1 configuration
        run: |
          echo "ðŸ” Checking Tauri v1 configuration..."
          echo "=== package.json Tauri dependencies ==="
          grep -A5 -B5 '"@tauri-apps' package.json || echo "âŒ No Tauri deps found"
          echo ""
          echo "=== Cargo.toml Tauri version ==="
          grep -A5 -B5 'tauri.*=' src-tauri/Cargo.toml || echo "âŒ No Tauri in Cargo.toml"
          echo ""
          echo "=== tauri.conf.json format ==="
          head -10 src-tauri/tauri.conf.json || echo "âŒ No config file"
          echo ""
          echo "=== Project structure ==="
          echo "âœ… Source files:" && ls -la src/ | head -5
          echo "âœ… Tauri files:" && ls -la src-tauri/
          
      # Build with Tauri v1 optimizations
      - name: Build and Release with Tauri v1
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: "v__VERSION__"
          releaseName: "Project Pulse HE v__VERSION__ (Tauri v1 Fixed)"
          releaseBody: |
            ðŸŽ‰ **Project Pulse HE - ×ž×¢×¨×›×ª × ×™×”×•×œ ×¤×¨×•×™×§×˜×™× ×ž×ª×§×“×ž×ª ×‘×¢×‘×¨×™×ª**
            
            ## âœ¨ Tauri v1 - ×‘×¢×™×•×ª ×ª×•×§× ×•!
            - âœ… **×¤×ª×™×—×ª ×ª×™×§×™×•×ª ×¢×•×‘×“×ª** - Mac, Windows, Linux
            - âœ… **WhatsApp integration ×ž×•×©×œ×** - Desktop + Web fallback
            - âœ… **Gmail ×¢× × ×•×©× ××•×˜×•×ž×˜×™** - × ×¤×ª×— ×¢× ×›×•×ª×¨×ª ×”×¤×¨×•×™×§×˜
            - âœ… **×—×™×•×’ ×˜×œ×¤×•×Ÿ ×‘×œ×—×™×¦×”** - ×¤×•×¢×œ ×‘×ž×¢×¨×›×•×ª ×©×ª×•×ž×›×•×ª
            - âœ… **×ž×¢×¨×›×ª ×¢×‘×¨×™×ª ×ž×œ××”** - RTL ×•×ª×ž×™×›×” ×™×©×¨××œ×™×ª ×ž×•×©×œ×ž×ª
            - âœ… **×‘×™×¦×•×¢×™× ×ž×©×•×¤×¨×™×** - Tauri v1 ×ž×”×™×¨ ×•×™×¦×™×‘
            
            ## ðŸ“¥ ×”×•×¨×“×” ×œ×ž×§:
            - **macOS Universal (Intel + Apple Silicon)**: ×”×•×¨×“ ××ª ×§×•×‘×¥ ×”-DMG
            
            ## ðŸ› ï¸ ×ª×™×§×•× ×™× ×‘×’×¨×¡×” ×–×•:
            - ×¤×ª×™×—×ª ×ª×™×§×™×•×ª ×¤×•×¢×œ×ª ×‘×›×œ ×”×ž×¢×¨×›×•×ª
            - ×§×™×©×•×¨×™ WhatsApp ×¢×•×‘×“×™× ×œ×œ× ×—×¡×™×ž×•×ª
            - ×¤×ª×™×—×ª Gmail ×¢× × ×•×©× ×ž×•×ª×× ×œ×›×œ ×¤×¨×•×™×§×˜
            - ×ž×ž×©×§ ×¢×‘×¨×™×ª RTL ×ž×•×©×œ×
            - ×”×ª×§× ×” ×¤×©×•×˜×” ×•×—×œ×§×”
            
            **×˜×›× ×•×œ×•×’×™×”:** Tauri v1.5 (×™×¦×™×‘ ×•×ž×•×›×—)
          releaseDraft: false
          prerelease: false
          args: --target universal-apple-darwin
          
      # Enhanced debugging for build results
      - name: Debug build results (Tauri v1)
        if: always()
        run: |
          echo "ðŸ” Checking Tauri v1 build results..."
          echo "=== Target directory overview ==="
          find src-tauri/target -type d 2>/dev/null | grep -E "(release|bundle)" | head -10
          echo ""
          echo "=== Universal build check ==="
          ls -la src-tauri/target/universal-apple-darwin/release/ 2>/dev/null || echo "âŒ Universal release dir missing"
          echo ""
          echo "=== Bundle directory contents ==="
          find src-tauri/target -name "bundle" -type d -exec ls -la {} \; 2>/dev/null || echo "âŒ No bundle dir"
          echo ""
          echo "=== DMG files ==="
          find src-tauri/target -name "*.dmg" -type f 2>/dev/null || echo "âŒ No DMG files found"
          echo ""
          echo "=== APP files ==="
          find src-tauri/target -name "*.app" -type d 2>/dev/null || echo "âŒ No APP files found"
          echo ""
          echo "=== Complete release structure ==="
          find src-tauri/target/universal-apple-darwin/release/bundle/ -ls 2>/dev/null || echo "âŒ Bundle structure missing"
          
      # Final verification
      - name: Verify Tauri v1 build success
        if: always()
        run: |
          echo "ðŸŽ¯ Final verification for Tauri v1..."
          
          DMG_COUNT=$(find src-tauri/target -name "*.dmg" 2>/dev/null | wc -l)
          APP_COUNT=$(find src-tauri/target -name "*.app" 2>/dev/null | wc -l)
          
          echo "ðŸ“Š Build summary:"
          echo "   DMG files found: $DMG_COUNT"
          echo "   APP files found: $APP_COUNT"
          
          if [ "$DMG_COUNT" -gt 0 ] || [ "$APP_COUNT" -gt 0 ]; then
            echo "âœ… BUILD SUCCESS - Files created!"
            find src-tauri/target -name "*.dmg" -o -name "*.app" 2>/dev/null | head -5
          else
            echo "âŒ BUILD FAILED - No installer files found"
            echo "ðŸ” Checking for any build artifacts..."
            find src-tauri/target -type f -name "*Project*" -o -name "*pulse*" 2>/dev/null | head -10
          fi
